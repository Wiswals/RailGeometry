::[Bat To Exe Converter]
::
::fBE1pAF6MU+EWHreyHcjLQlHcCiHK2KpEYkz5u3f/eORpw1QFM4+doub6aGcNuUK+XnDfIIlw3hmqsoFADxdcR+ueh0tlUdMv3CMNsuVoArVWEmK7Ww1FGhxk3HJsz1rLoImidIPsw==
::fBE1pAF6MU+EWHreyHcjLQlHcCiHK2KpEYkz5u3f/eORpw1QFM4+doub6aGcNuUK+XnDfIIlw3hmqsoFADxdcR+ueh0tlU1DumeQO8aItjvzS0uCwU4/FmBglXrvmnt1MZ17i89j
::YAwzoRdxOk+EWAjk
::fBw5plQjdCyDJGyX8VAjFDdRWw2RK1eVCLA4+uHt6qrK4mEcWuZ/S5rJzLGXM9w041HsYJQR5HtTlOwJAxZdagCyUhsmqG1JsWGKOsKIoRbeHGaf2UIzFGs6jmDf7A==
::YAwzuBVtJxjWCl3EqQJgSA==
::ZR4luwNxJguZRRnk
::Yhs/ulQjdF+5
::cxAkpRVqdFKZSzk=
::cBs/ulQjdF65
::ZR41oxFsdFKZSDk=
::eBoioBt6dFKZSDk=
::cRo6pxp7LAbNWATEpSI=
::egkzugNsPRvcWATEpCI=
::dAsiuh18IRvcCxnZtBJQ
::cRYluBh/LU+EWAnk
::YxY4rhs+aU+IeA==
::cxY6rQJ7JhzQF1fEqQJgZkoaHErSXA==
::ZQ05rAF9IBncCkqN+0xwdVsEAlXMbCXqZg==
::ZQ05rAF9IAHYFVzEqQIRPQ9bQQWWOW/6Mqcd6+O7yO+Ir0gJRvtf
::eg0/rx1wNQPfEVWB+kM9LVsJDGQ=
::fBEirQZwNQPfEVWB+kM9LVsJDGQ=
::cRolqwZ3JBvQF1fEqQJQ
::dhA7uBVwLU+EWDk=
::YQ03rBFzNR3SWATElA==
::dhAmsQZ3MwfNWATEwGQ0EHs=
::ZQ0/vhVqMQ3MEVWAtB9wSA==
::Zg8zqx1/OA3MEVWAtB9wSA==
::dhA7pRFwIByZRRnk
::Zh4grVQjdCyDJGyX8VAjFDdRWw2RC1eVCLA4+uHt6qrK4mEcWuZ/S5rJzLGXM9w041HsYJQR5HtTlOwJAxZdagCyUi4hvWFPt3CAM4eooQ7iQQiu40Q9HnFmni3VlC5b
::YB416Ek+ZW8=
::
::
::978f952a14a936cc963da21a135fa983
::[Bat To Exe Converter]
::
::fBE1pAF6MU+EWHreyHcjLQlHcCiHK2KpEYkz5u3f/eORpw1QFM4+doub6aGcNuUK+XnDfIIlw3hmqsoFADxdcR+ueh0tlUdMv3CMNsuVoArVWEmK7Ww1FGhxk3HJsz1rLoImidIPsw==
::fBE1pAF6MU+EWHreyHcjLQlHcCiHK2KpEYkz5u3f/eORpw1QFM4+doub6aGcNuUK+XnDfIIlw3hmqsoFADxdcR+ueh0tlU1DumeQO8aItjvzS0uCwU4/FmBglXrvmnt1MZ17i89j
::YAwzoRdxOk+EWAjk
::fBw5plQjdCyDJGyX8VAjFDdRWw2RK1eVCLA4+uHt6qrK4mEcWuZ/S5rJzLGXM9w041HsYJQR5HtTlOwJAxZdagCyUhsmqG1JsWGKOsKIoRbeHGaf2UIzFGs6jmDf7A==
::YAwzuBVtJxjWCl3EqQJgSA==
::ZR4luwNxJguZRRnk
::Yhs/ulQjdF+5
::cxAkpRVqdFKZSzk=
::cBs/ulQjdF65
::ZR41oxFsdFKZSDk=
::eBoioBt6dFKZSDk=
::cRo6pxp7LAbNWATEpSI=
::egkzugNsPRvcWATEpCI=
::dAsiuh18IRvcCxnZtBJQ
::cRYluBh/LU+EWAnk
::YxY4rhs+aU+JeA==
::cxY6rQJ7JhzQF1fEqQJQ
::ZQ05rAF9IBncCkqN+0xwdVs0
::ZQ05rAF9IAHYFVzEqQJQ
::eg0/rx1wNQPfEVWB+kM9LVsJDGQ=
::fBEirQZwNQPfEVWB+kM9LVsJDGQ=
::cRolqwZ3JBvQF1fEqQJQ
::dhA7uBVwLU+EWDk=
::YQ03rBFzNR3SWATElA==
::dhAmsQZ3MwfNWATElA==
::ZQ0/vhVqMQ3MEVWAtB9wSA==
::Zg8zqx1/OA3MEVWAtB9wSA==
::dhA7pRFwIByZRRnk
::Zh4grVQjdCyDJGyX8VAjFDdRWw2RK1eVCLA4+uHt6qrK4mEcWuZ/S5rJzLGXM9w041HsYJQR5HtTlOwJAxZdagCyUi4hvWFPt3CAM4eooQ7iQQiu40Q9HnFmni3VlC5b
::YB416Ek+ZW8=
::
::
::978f952a14a936cc963da21a135fa983

@echo off

SET Directory=%~dp0
SET Log_File="%Directory%ATG_LogFile.txt"
SET Config_File=%Directory%ATG_Configure.ini

@echo.>>%Log_File%
@echo =============================================================================================================================================================>>%Log_File%
@echo %date% %time% - Automated Track Geometry initiated.>>%Log_File%
@echo %date% %time% - Automated Track Geometry initiated.

rem Check the licence for this software is valid.
set Licence=01/01/2030

SETLOCAL EnableDelayedExpansion

    for /f "skip=1 tokens=1-6 delims= " %%a in ('wmic path Win32_LocalTime Get Day^,Hour^,Minute^,Month^,Second^,Year /Format:table') do (
        IF NOT "%%~f"=="" (
            set /a Today=10000 * %%f + 100 * %%d + %%a
            set Today=!Today:~-2,2!/!Today:~-4,2!/!Today:~-6,2!))

set "Licence=%Licence:~-2%%Licence:~3,2%%Licence:~0,2%"
set "Today=%Today:~-2%%Today:~3,2%%Today:~0,2%"

if %Today% GTR %Licence% (
    @echo.>>%Log_File%
    @echo %date% %time% - Error, software licence has expired, please contact lwalsh@landsurveys.net.au to renew.>>%Log_File%
    @echo =============================================================================================================================================================>>%Log_File%
    set /p Error=Press ENTER to exit...
	Exit)


rem Get configuration settings from the .ini file
@echo %date% %time% - Extracting user values from the configuration file...>>%Log_File%
@echo %date% %time% - Extracting user values from the configuration file.

if exist "%Config_File%" ( goto File_read ) else ( goto File_err_handler )

:File_err_handler
	@echo %date% %time% - Error, the configuration file %Config_File% could not be found.>>%Log_File%
	@echo %date% %time% - Batch file terminated.>>%Log_File%
    @echo =============================================================================================================================================================>>%Log_File%
	Exit

:File_read 
    FOR /f "usebackq tokens=1,2 delims==, eol=#" %%a IN ( "%Config_File%" ) DO (
    IF %%a==::ServerName SET ServerName=%%b
    IF %%a==::DatabaseName SET DatabaseName=%%b
    IF %%a==::CalculationFrequency SET CalculationFrequency=%%b
    IF %%a==::DataExtractionWindow SET DataExtractionWindow=%%b
    IF %%a==::OverdueDataWarning SET OverdueDataWarning=%%b
    IF %%a==::SendOverdueEmail SET SendOverdueEmail=%%b
    IF %%a==::EmailProfile SET EmailProfile=%%b
    IF %%a==::EmailRecipients SET EmailRecipients=%%b
    IF %%a==::ChainageStep SET ChainageStep=%%b
    IF %%a==::PrismSpacingLimit SET PrismSpacingLimit=%%b
    IF %%a==::ShortTwistStep SET ShortTwistStep=%%b
    IF %%a==::LongTwistStep SET LongTwistStep=%%b
    IF %%a==::ShortLineChord SET ShortLineChord=%%b
    IF %%a==::LongLineChord SET LongLineChord=%%b
    IF %%a==::ShortTopChord SET ShortTopChord=%%b
    IF %%a==::LongTopChord SET LongTopChord=%%b
    IF %%a==::LeftRailIndicator SET LeftRailIndicator=%%b
    IF %%a==::RightRailIndicator SET RightRailIndicator=%%b
    IF %%a==::ChainageNameFormat SET ChainageNameFormat=%%b)

    IF "%ServerName%" == "" (@echo - Warning: Server Name not set, will use default value.)>>%Log_File%
    IF "%DatabaseName%" == "" (@echo - Warning: Database Name not set, will use default value.)>>%Log_File%
    IF "%CalculationFrequency%" == "" (@echo - Warning: Calculation Frequency not set, will use default value.)>>%Log_File%
    IF "%DataExtractionWindow%" == "" (@echo - Warning: Data Extraction Window not set, will use default value.)>>%Log_File%
    IF "%OverdueDataWarning%" == "" (@echo - Warning: Overdue Data Warning not set, will use default value.)>>%Log_File%
    IF "%SendOverdueEmail%" == "" (@echo - Warning: Send Overdue Email Alert not set, will use default value.)>>%Log_File%
    IF "%EmailProfile%" == "" (@echo - Warning: Email Profile not set, will use default value.)>>%Log_File%
    IF "%EmailRecipients%" == "" (@echo - Warning: Email Recipients List not set, will use default value.)>>%Log_File%
    IF "%ChainageStep%" == "" (@echo - Warning: Track Chainage Interpolation Step not set, will use default value.)>>%Log_File%
    IF "%PrismSpacingLimit%" == "" (@echo - Warning: Prism Spacing Limit not set, will use default value.)>>%Log_File%
    IF "%ShortTwistStep%" == "" (@echo - Warning: Short Twist Step Length not set, will use default value.)>>%Log_File%
    IF "%LongTwistStep%" == "" (@echo - Warning: Long Twist Step Length not set, will use default value.)>>%Log_File%
    IF "%ShortLineChord%" == "" (@echo - Warning: Short Line Chord Length not set, will use default value.)>>%Log_File%
    IF "%LongLineChord%" == "" (@echo - Warning: Long Line Chord Length not set, will use default value.)>>%Log_File%
    IF "%ShortTopChord%" == "" (@echo - Warning: Short Top Chord Length not set, will use default value.)>>%Log_File%
    IF "%LongTopChord%" == "" (@echo - Warning: Long Top Chord Length not set, will use default value.)>>%Log_File%
    IF "%LeftRailIndicator%" == "" (@echo - Warning: Left Rail Naming Indicator not set, will use default value.)>>%Log_File%
    IF "%RightRailIndicator%" == "" (@echo - Warning: Right Rail Naming Indicator not set, will use default value.)>>%Log_File%
    IF "%ChainageNameFormat%" == "" (@echo - Warning: Chainage Name Format not set, will use default value.)>>%Log_File%
    @echo.>>%Log_File%

rem Test the connection to the specified server
@echo %date% %time% - Testing server connection to %ServerName%...>>%Log_File%
sqlcmd -S "%ServerName%" -E -Q " "

if ERRORLEVEL 1 goto Connection_err_handler
		        goto Connection_made

	:Connection_err_handler
	@echo %date% %time% - SQLCMD returned %errorlevel% to the command shell.... Error could not connect to specified server.>>%Log_File%
	@echo %date% %time% - Batch file terminated.>>%Log_File%
    @echo =============================================================================================================================================================>>%Log_File%
	Exit
	
	:Connection_made
	@echo %date% %time% - Server connected.>>%Log_File%
    @echo %date% %time% - Server connected.

rem Test the connection to the specified database
@echo %date% %time% - Testing database connection to %DatabaseName%...>>%Log_File%
set Query="SET NOCOUNT ON; SELECT CASE WHEN COUNT(name) = 0 Then 'Doesnt Exsist' else 'Database Exsits' end AS DatabaseCheck FROM sys.databases WHERE name LIKE '%DatabaseName%'"

sqlcmd -S "%ServerName%" -E -Q %Query% -h -1 -o "%Directory%temp.txt"
set /P DatabaseResult= < "%Directory%temp.txt"
del "%Directory%temp.txt"

IF "%DatabaseResult%"=="Doesnt Exsist  " (
	@echo %date% %time% - Error, database not recognised or unable to connect, please try again.>>%Log_File%
    @echo =============================================================================================================================================================>>%Log_File%
	Exit )
	
@echo %date% %time% - Database connected.>>%Log_File%
@echo %date% %time% - Database connected.
@echo.>>%Log_File%

@echo %date% %time% - Running track initalisation script...>>%Log_File%
@echo %date% %time% - Running track initalisation script.
rem Run the inalisation script - %b2eincfile1%
sqlcmd -S "%ServerName%" -E -d "%DatabaseName%" -i "%b2eincfile1%" -h -1 >>%Log_File%
@echo.>>%Log_File%

@echo %date% %time% - Running track geometry calculation script...>>%Log_File%
@echo %date% %time% - Running track geometry calculation script.
rem Run the automated track geometry script
sqlcmd -S "%ServerName%" -E -d "%DatabaseName%" -i "%b2eincfile2%" -v CalculationFrequency="%CalculationFrequency%" DataExtractionWindow="%DataExtractionWindow%" OverdueDataWarning="%OverdueDataWarning%" SendOverdueEmail="%SendOverdueEmail%" PrismSpacingLimit="%PrismSpacingLimit%" ChainageStep="%ChainageStep%" ShortTwistStep="%ShortTwistStep%" LongTwistStep="%LongTwistStep%" ShortLineChord="%ShortLineChord%" LongLineChord="%LongLineChord%" ShortTopChord="%ShortTopChord%" LongTopChord="%LongTopChord%" LeftRailIndicator="%LeftRailIndicator%" RightRailIndicator="%RightRailIndicator%" EmailProfile="%EmailProfile%" EmailRecipients="%EmailRecipients%" ChainageNameFormat="%ChainageNameFormat%" -h -1 >>%Log_File%
@echo.>>%Log_File%

@echo %date% %time% - Automated Track Geometry completed.>>%Log_File%
@echo %date% %time% - Automated Track Geometry completed.
@echo =============================================================================================================================================================>>%Log_File%